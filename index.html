<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barry Risk – Twitch Chat Overlay</title>
  <!--
    HOW TO USE IN OBS
    1) Save this file as something like: C:\Users\pukka\Downloads\barry_risk_chat_overlay.html
    2) In OBS: Sources → + → Browser → Create new → check "Local file" → Browse to the file above.
    3) Set Width/Height to match your canvas (e.g. 800×1000 for a vertical chat or 1200×400 for a bar).
    4) Right‑click the source → Interact is NOT needed; the overlay connects to Twitch automatically.
    5) Background is transparent. Position & crop like any other source.

    OPTIONAL URL PARAMS (append when using as a URL source or after the file name in OBS):
      ?channel=barry_risk&max=12&fade=25&font=22&badge=1&hidecmd=1&shadow=1

      channel  – Twitch channel to read (default: barry_risk)
      max      – max messages on screen (default: 10)
      fade     – seconds before a message fades out (0 = never) (default: 20)
      font     – base font size in px (default: 20)
      badge    – show badges (0/1) (default: 1)
      hidecmd  – hide messages starting with '!' (0/1) (default: 1)
      shadow   – heavier text glow (0/1) (default: 1)

    NOTE: This overlay uses tmi.js (Twitch IRC). It supports native Twitch emotes.
  -->
  <style>
    :root {
      --bg: transparent;
      --panel: rgba(10, 14, 23, 0.35);
      --text: #e9f2ff;
      --name: #a9d4ff;
      --accent: #6ec3ff; /* neon-ish cyan */
      --accent-2: #ffffff;
      --highlight: rgba(110, 195, 255, 0.18);
      --danger: #ff5f5f;
      --muted: #8aa0b8;
      --radius: 18px;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      overflow: hidden;
    }

    .wrap {
      box-sizing: border-box;
      height: 100%;
      width: 100%;
      padding: 10px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      gap: 8px;
    }

    .msg {
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      background: var(--panel);
      border: 1px solid rgba(110,195,255,0.25);
      border-left: 3px solid var(--accent);
      border-radius: var(--radius);
      padding: 10px 12px;
      backdrop-filter: blur(6px) saturate(130%);
      -webkit-backdrop-filter: blur(6px) saturate(130%);
      animation: pop 180ms ease-out;
    }

    .msg.highlight {
      background: var(--highlight);
      border-color: rgba(255,255,255,0.35);
      border-left-color: var(--accent-2);
      box-shadow: 0 0 28px rgba(110,195,255,0.12), inset 0 0 0 1px rgba(255,255,255,0.04);
    }

    .avatar {
      width: 0; /* Hidden by default (we don't fetch avatars here). Keep slot for future.) */
      height: 0;
      border-radius: 50%;
      flex: 0 0 auto;
      display: none;
    }

    .bubble {
      flex: 1 1 auto;
      min-width: 0;
    }

    .name {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 700;
      color: var(--name);
      line-height: 1.2;
      margin-bottom: 2px;
      filter: drop-shadow(0 0 4px rgba(110,195,255,0.35));
    }

    .badges {
      display: inline-flex;
      gap: 4px;
      vertical-align: middle;
    }

    .badge {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      background: rgba(255,255,255,0.15);
      display: inline-block;
    }

    .text {
      color: var(--text);
      line-height: 1.35;
      word-wrap: break-word;
      overflow-wrap: anywhere;
    }

    .shadow .name, .shadow .text {
      text-shadow: 0 0 2px rgba(0,0,0,0.35), 0 0 12px rgba(110,195,255,0.15);
    }

    .emote {
      height: 1.25em;
      vertical-align: -0.2em;
    }

    .fadeout { opacity: 0; transition: opacity 800ms ease-out; }

    @keyframes pop {
      from { transform: translateY(6px) scale(0.98); opacity: 0; }
      to   { transform: translateY(0) scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="app" class="wrap shadow"></div>

  <script src="tmi.min.js"></script>
  <script>
    // ---------- Helpers ----------
    function getParams() {
      const url = new URL(window.location.href);
      const p = Object.fromEntries(url.searchParams.entries());
      return {
        channel: (p.channel || 'barry_risk').replace(/^#/, ''),
        max: Math.max(1, parseInt(p.max || '10', 10)),
        fade: Math.max(0, parseInt(p.fade || '20', 10)), // seconds; 0 = never
        font: Math.max(10, parseInt(p.font || '20', 10)),
        badge: p.badge === undefined ? 1 : Number(p.badge),
        hidecmd: p.hidecmd === undefined ? 1 : Number(p.hidecmd),
        shadow: p.shadow === undefined ? 1 : Number(p.shadow),
      };
    }

    const CFG = getParams();
    document.documentElement.style.fontSize = CFG.font + 'px';
    if (!CFG.shadow) document.getElementById('app').classList.remove('shadow');

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    function nameColorFromTag(color, name) {
      if (color) return color; // Twitch user-selected color
      // deterministic pastel from name
      let h = 0; for (let i=0;i<name.length;i++) h = (h*31 + name.charCodeAt(i)) >>> 0;
      const hue = h % 360; return `hsl(${hue} 70% 75%)`;
    }

    function buildEmoteMap(emotes) {
      // emotes: { emoteID: ["start-end", ...], ... }
      const parts = [];
      if (!emotes) return parts;
      Object.keys(emotes).forEach(id => {
        emotes[id].forEach(range => {
          const [s, e] = range.split('-').map(n => parseInt(n,10));
          parts.push({ id, start: s, end: e });
        });
      });
      return parts.sort((a,b) => a.start - b.start);
    }

    function renderMessageWithEmotes(text, emotes) {
      if (!emotes || Object.keys(emotes).length === 0) return escapeHtml(text);
      const ranges = buildEmoteMap(emotes);
      let out = '';
      let lastIndex = 0;
      for (const r of ranges) {
        // plaintext segment before emote
        if (lastIndex < r.start) out += escapeHtml(text.slice(lastIndex, r.start));
        const emoteText = text.slice(r.start, r.end + 1);
        const url = `https://static-cdn.jtvnw.net/emoticons/v2/${r.id}/default/dark/1.0`;
        out += `<img class="emote" alt="${escapeHtml(emoteText)}" src="${url}">`;
        lastIndex = r.end + 1;
      }
      // remaining text
      if (lastIndex < text.length) out += escapeHtml(text.slice(lastIndex));
      return out;
    }

    function shouldHideMessage(message) {
      if (!CFG.hidecmd) return false;
      return message.trim().startsWith('!');
    }

    // ---------- DOM & lifecycle ----------
    const app = document.getElementById('app');

    function addMessage({ displayName, color, isMod, isBroadcaster, isVip, isSub, textHTML, highlighted }) {
      const nameColor = nameColorFromTag(color, displayName);

      const el = document.createElement('div');
      el.className = 'msg' + (highlighted ? ' highlight' : '');
      el.innerHTML = `
        <div class="bubble">
          <div class="name" style="color:${nameColor}">
            <span>${escapeHtml(displayName)}</span>
            <span class="badges">
              ${isBroadcaster ? '<span class="badge" title="Broadcaster"></span>' : ''}
              ${isMod ? '<span class="badge" title="Mod" style="background:#43d17d"></span>' : ''}
              ${isVip ? '<span class="badge" title="VIP" style="background:#ff7de9"></span>' : ''}
              ${isSub ? '<span class="badge" title="Sub" style="background:#ffd166"></span>' : ''}
            </span>
          </div>
          <div class="text">${textHTML}</div>
        </div>`;

      app.appendChild(el);

      // Trim to max
      while (app.children.length > CFG.max) {
        app.removeChild(app.firstChild);
      }

      // Auto fade
      if (CFG.fade > 0) {
        setTimeout(() => { el.classList.add('fadeout'); }, CFG.fade * 1000);
        setTimeout(() => { if (el.parentNode) el.parentNode.removeChild(el); }, (CFG.fade * 1000) + 900);
      }
    }

    // ---------- Connect to Twitch IRC via tmi.js ----------
    const client = new tmi.Client({
      connection: { secure: true, reconnect: true },
      channels: [CFG.channel]
    });

    client.on('message', (channel, tags, message, self) => {
      if (self) return; // ignore our own
      if (shouldHideMessage(message)) return;

      try {
        const displayName = tags['display-name'] || tags.username || 'unknown';
        const color = tags['color'] || null;
        const isMod = tags.mod === true || tags.mod === '1';
        const isBroadcaster = tags.badges && (tags.badges.broadcaster === '1');
        const isVip = tags.badges && (tags.badges.vip === '1');
        const isSub = tags.subscriber === true || tags.subscriber === '1' || (tags.badges && (tags.badges.subscriber));
        const highlighted = tags['msg-id'] === 'highlighted-message';

        const textHTML = renderMessageWithEmotes(message, tags.emotes);
        addMessage({ displayName, color, isMod, isBroadcaster, isVip, isSub, textHTML, highlighted });
      } catch (err) {
        console.error('Render error', err);
      }
    });

    client.on('connected', () => {
      // Optional: initial system line
      addMessage({
        displayName: 'Chat Connected',
        color: '#6ec3ff',
        isMod: false, isBroadcaster: false, isVip: false, isSub: false,
        textHTML: `Now listening to <b>#${escapeHtml(CFG.channel)}</b>.`,
        highlighted: false,
      });
    });

    client.on('disconnected', () => {
      addMessage({
        displayName: 'Chat Disconnected',
        color: '#ff7d7d',
        isMod: false, isBroadcaster: false, isVip: false, isSub: false,
        textHTML: 'Attempting to reconnect…',
        highlighted: false,
      });
    });

    client.connect().catch(err => {
      console.error('tmi connection failed', err);
      addMessage({
        displayName: 'Error',
        color: '#ff7d7d',
        isMod: false, isBroadcaster: false, isVip: false, isSub: false,
        textHTML: 'Could not connect to Twitch chat. Is the channel name correct?',
        highlighted: true,
      });
    });
  </script>
</body>
</html>
